<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Carrito</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .debug-section { background: #f5f5f5; padding: 15px; margin: 10px 0; border-radius: 8px; }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .info { color: #007bff; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; background: #007bff; color: white; }
        .product-card { border: 1px solid #ddd; padding: 10px; margin: 5px; border-radius: 4px; display: inline-block; }
    </style>
</head>
<body>
    <h1>üêõ Debug Carrito de Compras</h1>
    <div id="results"></div>

    <div class="debug-section">
        <h3>Estado Inicial</h3>
        <button onclick="checkInitialState()">Verificar Estado Inicial</button>
        <button onclick="loadProducts()">Cargar Productos</button>
        <button onclick="testAddToCart()">Test Agregar al Carrito</button>
    </div>

    <div class="debug-section" id="products-section">
        <h3>Productos Disponibles</h3>
        <div id="products-list"></div>
    </div>

    <div class="debug-section" id="cart-section">
        <h3>Estado del Carrito</h3>
        <div id="cart-display"></div>
    </div>

    <script src="assets/js/database.js"></script>
    <script src="assets/js/auth.js"></script>
    <script src="assets/js/ventas.js"></script>
    <script>
        const results = document.getElementById('results');
        
        function log(message, type = 'info') {
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : 'info';
            results.innerHTML += `<p class="${className}">[${new Date().toLocaleTimeString()}] ${message}</p>`;
            console.log(message);
        }

        // Login autom√°tico
        function initializeSystem() {
            const db = new Database();
            const auth = new Auth();
            const loginResult = auth.login('admin', 'admin123');
            
            if (loginResult.success) {
                log('‚úÖ Sistema inicializado - Usuario logueado', 'success');
                return true;
            } else {
                log('‚ùå Error de login: ' + loginResult.message, 'error');
                return false;
            }
        }

        function checkInitialState() {
            log('üîç Verificando estado inicial...', 'info');
            
            // Verificar si salesManager existe
            if (window.salesManager) {
                log('‚úÖ salesManager est√° disponible globalmente', 'success');
                log(`- Tipo: ${typeof window.salesManager}`, 'info');
                log(`- Cart length: ${window.salesManager.cart ? window.salesManager.cart.length : 'undefined'}`, 'info');
            } else {
                log('‚ùå salesManager NO est√° disponible globalmente', 'error');
                
                // Intentar crear manualmente
                try {
                    window.salesManager = new SalesManager();
                    log('‚úÖ salesManager creado manualmente', 'success');
                } catch (error) {
                    log('‚ùå Error al crear salesManager: ' + error.message, 'error');
                }
            }

            // Verificar database
            if (window.salesManager && window.salesManager.db) {
                const products = window.salesManager.db.getProducts();
                log(`üì¶ Productos en DB: ${products.length}`, 'info');
                products.forEach((product, index) => {
                    if (index < 3) { // Solo mostrar los primeros 3
                        log(`   - ${product.nombre || product.name}: $${product.precio || product.price}`, 'info');
                    }
                });
            }
        }

        function loadProducts() {
            if (!window.salesManager) {
                log('‚ùå salesManager no disponible', 'error');
                return;
            }

            try {
                const products = window.salesManager.db.getProducts();
                const productsList = document.getElementById('products-list');
                
                if (products.length === 0) {
                    productsList.innerHTML = '<p>No hay productos disponibles</p>';
                    log('‚ö†Ô∏è No hay productos en la base de datos', 'error');
                    return;
                }

                productsList.innerHTML = products.map(product => `
                    <div class="product-card">
                        <h4>${product.nombre || product.name}</h4>
                        <p>$${(product.precio || product.price).toLocaleString()}</p>
                        <button onclick="testAddProduct(${product.id})">Agregar al Carrito</button>
                    </div>
                `).join('');

                log(`‚úÖ ${products.length} productos cargados y mostrados`, 'success');
            } catch (error) {
                log('‚ùå Error al cargar productos: ' + error.message, 'error');
            }
        }

        function testAddProduct(productId) {
            if (!window.salesManager) {
                log('‚ùå salesManager no disponible', 'error');
                return;
            }

            try {
                log(`üõí Intentando agregar producto ID: ${productId}`, 'info');
                
                // Verificar que el producto existe
                const products = window.salesManager.db.getProducts();
                const product = products.find(p => p.id === productId);
                
                if (!product) {
                    log(`‚ùå Producto ${productId} no encontrado`, 'error');
                    return;
                }

                log(`‚úÖ Producto encontrado: ${product.nombre || product.name}`, 'success');

                // Intentar agregar al carrito
                const cartLengthBefore = window.salesManager.cart.length;
                window.salesManager.addToCart(productId);
                const cartLengthAfter = window.salesManager.cart.length;

                log(`üìä Carrito antes: ${cartLengthBefore}, despu√©s: ${cartLengthAfter}`, 'info');

                if (cartLengthAfter > cartLengthBefore) {
                    log('‚úÖ Producto agregado exitosamente al carrito', 'success');
                } else {
                    log('‚ö†Ô∏è El carrito no cambi√≥ de tama√±o (posible item duplicado)', 'info');
                }

                updateCartDisplay();

            } catch (error) {
                log('‚ùå Error al agregar producto: ' + error.message, 'error');
                console.error(error);
            }
        }

        function testAddToCart() {
            if (!window.salesManager) {
                log('‚ùå salesManager no disponible', 'error');
                return;
            }

            const products = window.salesManager.db.getProducts();
            if (products.length > 0) {
                testAddProduct(products[0].id);
            } else {
                log('‚ùå No hay productos para probar', 'error');
            }
        }

        function updateCartDisplay() {
            if (!window.salesManager) return;

            const cartDisplay = document.getElementById('cart-display');
            const cart = window.salesManager.cart;

            if (cart.length === 0) {
                cartDisplay.innerHTML = '<p>Carrito vac√≠o</p>';
            } else {
                cartDisplay.innerHTML = `
                    <p><strong>Items en carrito: ${cart.length}</strong></p>
                    ${cart.map(item => `
                        <div style="border: 1px solid #ccc; padding: 8px; margin: 4px;">
                            <strong>${item.product.nombre || item.product.name}</strong><br>
                            Cantidad: ${item.quantity}<br>
                            Subtotal: $${item.subtotal.toLocaleString()}
                        </div>
                    `).join('')}
                    <p><strong>Total: $${window.salesManager.currentOrder.total.toLocaleString()}</strong></p>
                `;
            }
        }

        // Inicializar cuando se carga la p√°gina
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                if (initializeSystem()) {
                    checkInitialState();
                    loadProducts();
                    updateCartDisplay();
                }
            }, 1000); // Dar tiempo para que se cargue ventas.js
        });
    </script>
</body>
</html>