<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Sistema Completo</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { background: #f5f5f5; padding: 15px; margin: 10px 0; border-radius: 8px; }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .info { color: #007bff; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: black; }
    </style>
</head>
<body>
    <h1>üß™ Test Sistema POS Completo</h1>
    <div id="results"></div>

    <div class="test-section">
        <h3>Acciones de Prueba</h3>
        <button class="btn-primary" onclick="createTestOrder()">Crear Pedido de Prueba</button>
        <button class="btn-success" onclick="markOrderReady()">Marcar Pedido Listo</button>
        <button class="btn-warning" onclick="processTestPayment()">Procesar Pago</button>
        <button class="btn-primary" onclick="cleanTable()">Limpiar Mesa</button>
    </div>

    <div class="test-section">
        <h3>Navegaci√≥n R√°pida</h3>
        <button class="btn-primary" onclick="openPage('ventas.html')">Abrir Ventas</button>
        <button class="btn-primary" onclick="openPage('pedidos.html')">Abrir Pedidos</button>
        <button class="btn-primary" onclick="openPage('mesas.html')">Abrir Mesas</button>
    </div>

    <script src="assets/js/database.js"></script>
    <script src="assets/js/auth.js"></script>
    <script>
        const results = document.getElementById('results');
        
        function log(message, type = 'info') {
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : 'info';
            results.innerHTML += `<p class="${className}">${message}</p>`;
            console.log(message);
        }

        // Inicializar
        const db = new Database();
        const auth = new Auth();

        // Login autom√°tico
        const loginResult = auth.login('admin', 'admin123');
        if (loginResult.success) {
            log('‚úÖ Sistema inicializado correctamente', 'success');
            showSystemStatus();
        } else {
            log('‚ùå Error de login: ' + loginResult.message, 'error');
        }

        function showSystemStatus() {
            const orders = db.getOrders();
            const tables = db.getTables();
            const products = db.getProducts();
            
            log(`üìä Estado del Sistema:`, 'info');
            log(`   - Pedidos: ${orders.length}`, 'info');
            log(`   - Mesas: ${tables.length}`, 'info');
            log(`   - Productos: ${products.length}`, 'info');
            log(`   - Mesas ocupadas: ${tables.filter(t => t.estado === 'ocupada').length}`, 'info');
            log(`   - Mesas en limpieza: ${tables.filter(t => t.estado === 'limpieza').length}`, 'info');
        }

        function createTestOrder() {
            const testOrder = {
                id: Date.now(),
                items: [
                    {
                        productId: 1,
                        productName: 'Caf√© Americano',
                        quantity: 1,
                        unitPrice: 3500,
                        subtotal: 3500,
                        estado: 'pendiente'
                    },
                    {
                        productId: 4,
                        productName: 'Cr√™pe de Nutella',
                        quantity: 1,
                        unitPrice: 8000,
                        subtotal: 8000,
                        estado: 'pendiente'
                    }
                ],
                total: 11500,
                mesa: 2,
                tipo: 'mesa',
                estado: 'pendiente',
                timestamp: new Date().toISOString(),
                fecha: new Date().toLocaleDateString('es-ES'),
                hora: new Date().toLocaleTimeString('es-ES', {hour: '2-digit', minute: '2-digit'})
            };
            
            db.saveOrder(testOrder);
            
            // Actualizar mesa
            const tables = db.getTables();
            const table = tables.find(t => t.numero == 2);
            if (table) {
                table.estado = 'ocupada';
                table.pedidoId = testOrder.id;
                table.ultimaActividad = new Date().toISOString();
                db.updateTable(table.id, table);
            }
            
            log(`‚úÖ Pedido creado: #${testOrder.id} - Mesa 2`, 'success');
            showSystemStatus();
        }

        function markOrderReady() {
            const orders = db.getOrders();
            const pendingOrder = orders.find(o => o.estado === 'pendiente' || o.estado === 'preparando');
            
            if (!pendingOrder) {
                log('‚ùå No hay pedidos pendientes para marcar como listos', 'error');
                return;
            }
            
            // Marcar items como listos
            pendingOrder.items.forEach(item => {
                item.estado = 'listo';
                item.finalizacion = new Date().toISOString();
            });
            
            pendingOrder.estado = 'listo';
            db.saveOrder(pendingOrder);
            
            log(`‚úÖ Pedido #${pendingOrder.id} marcado como listo`, 'success');
            showSystemStatus();
        }

        function processTestPayment() {
            const orders = db.getOrders();
            const readyOrder = orders.find(o => o.estado === 'listo');
            
            if (!readyOrder) {
                log('‚ùå No hay pedidos listos para procesar pago', 'error');
                return;
            }
            
            // Procesar pago
            readyOrder.estado = 'pagado';
            readyOrder.metodoPago = 'efectivo';
            readyOrder.fechaPago = new Date().toISOString();
            db.saveOrder(readyOrder);
            
            // Marcar mesa en limpieza
            if (readyOrder.mesa) {
                const tables = db.getTables();
                const table = tables.find(t => t.numero == readyOrder.mesa);
                if (table) {
                    table.estado = 'limpieza';
                    db.updateTable(table.id, table);
                }
            }
            
            log(`‚úÖ Pago procesado para pedido #${readyOrder.id} - Mesa ${readyOrder.mesa} en limpieza`, 'success');
            showSystemStatus();
        }

        function cleanTable() {
            const tables = db.getTables();
            const dirtyTable = tables.find(t => t.estado === 'limpieza');
            
            if (!dirtyTable) {
                log('‚ùå No hay mesas en limpieza', 'error');
                return;
            }
            
            dirtyTable.estado = 'libre';
            dirtyTable.pedidoId = null;
            dirtyTable.ultimaActividad = new Date().toISOString();
            db.updateTable(dirtyTable.id, dirtyTable);
            
            log(`‚úÖ Mesa ${dirtyTable.numero} limpia y disponible`, 'success');
            showSystemStatus();
        }

        function openPage(page) {
            window.open(page, '_blank');
        }

        // Auto-actualizar cada 5 segundos
        setInterval(showSystemStatus, 5000);
    </script>
</body>
</html>